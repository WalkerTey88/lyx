// ===== LYX 点单 · Google Apps Script 后台（优化版 / ES5 兼容）=====

// 配置：前后端必须一致
var CONFIG = {
  SECRET: "Lyx115599$api", // 与 index.html 的 CLOUD.SECRET 一致
  SHEET_ID: "1mEx1LPaFYsBisXs5mOp-TA_P_9ntfpvMSVzdyKUveKk", // 表格ID
  SHEET_NAME: "Orders",    // 工作表名
  DELETE_PWD: "Lyx115599$" // 删除密码（移到后端管理）
};

// ===== 通用工具 =====

// 统一 JSON 输出
function _json(obj) {
  obj.ts = (new Date()).toISOString();
  return ContentService
    .createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}

// 确保表头存在
function ensureHeader_(sh, headers) {
  var range = sh.getRange(1, 1, 1, headers.length);
  var values = range.getValues();
  var same = true;
  for (var i = 0; i < headers.length; i++) {
    if (values[0][i] !== headers[i]) { same = false; break; }
  }
  if (!same) {
    range.setValues([headers]);
  }
}

// ===== API 接口 =====

// 健康检查
function doGet(e) {
  return _json({ ok: true, ping: true });
}

// 主入口
function doPost(e) {
  try {
    if (!e || !e.postData || !e.postData.contents) {
      return _json({ ok: false, error: "no_body" });
    }

    var body;
    try {
      body = JSON.parse(e.postData.contents);
    } catch (errParse) {
      return _json({ ok: false, error: "invalid_json" });
    }

    if (!body || body.secret !== CONFIG.SECRET) {
      return _json({ ok: false, error: "unauthorized" });
    }

    // 可选覆盖表格ID
    var sheetId = (body.spreadsheetId && String(body.spreadsheetId).length > 10)
      ? body.spreadsheetId
      : CONFIG.SHEET_ID;

    var ss = SpreadsheetApp.openById(sheetId);
    var sh = ss.getSheetByName(CONFIG.SHEET_NAME) || ss.insertSheet(CONFIG.SHEET_NAME);

    // 表头
    var headers = [
      "OrderID", "Employee", "TableNo", "Takeaway", "Note",
      "ItemsJSON", "Total", "CreatedAt", "Lang", "DeviceID", "Deleted?", "PriceList"
    ];
    ensureHeader_(sh, headers);

    var action = (body.action || "create").toLowerCase();

    // 删除操作
    if (action === "delete") {
      if (!body.order || !body.order.id) {
        return _json({ ok: false, error: "missing_order_id_for_delete" });
      }
      if (!body.pwd || body.pwd !== CONFIG.DELETE_PWD) {
        return _json({ ok: false, error: "wrong_delete_password" });
      }
      markDeleted_(sh, headers, String(body.order.id));
      return _json({ ok: true, action: "delete", id: String(body.order.id) });
    }

    // 标准化订单
    var order = normalizeOrder_(body);
    if (!order || !order.id) {
      return _json({ ok: false, error: "missing_order_id" });
    }

    upsertOrder_(sh, headers, order);
    return _json({ ok: true, action: "create", id: order.id });

  } catch (err) {
    return _json({ ok: false, error: "server_error", detail: String(err) });
  }
}

// ===== 业务函数 =====

// 软删除（只扫描 OrderID 列）
function markDeleted_(sh, headers, orderId) {
  var idxId = headers.indexOf("OrderID") + 1;
  var idxDel = headers.indexOf("Deleted?") + 1;
  if (idxId <= 0 || idxDel <= 0) return;

  var idCol = sh.getRange(2, idxId, sh.getLastRow() - 1, 1).getValues();
  for (var r = 0; r < idCol.length; r++) {
    if (String(idCol[r][0]) === String(orderId)) {
      sh.getRange(r + 2, idxDel).setValue(true);
      return;
    }
  }
}

// upsert（只扫描 OrderID 列）
function upsertOrder_(sh, headers, order) {
  var row = [
    String(order.id || ""),
    String(order.employee || ""),
    String(order.tableNo || ""),
    Boolean(order.takeaway || false),
    String(order.note || ""),
    JSON.stringify(order.items || []),
    Number(order.total || 0),
    String(order.createdAt || (new Date()).toISOString()),
    String(order.lang || ""),
    String(order.deviceId || ""),
    false,
    JSON.stringify(order.items.map(function(it){ return {id: it.id, price: it.price}; }))
  ];

  var idxId = headers.indexOf("OrderID") + 1;
  var idCol = sh.getRange(2, idxId, Math.max(0, sh.getLastRow()-1), 1).getValues();
  for (var r = 0; r < idCol.length; r++) {
    if (String(idCol[r][0]) === String(order.id)) {
      sh.getRange(r + 2, 1, 1, row.length).setValues([row]);
      return;
    }
  }
  sh.appendRow(row);
}

// 标准化订单
function normalizeOrder_(body) {
  if (body && body.order && body.order.id) {
    var o = body.order;
    return {
      id: String(o.id || ""),
      employee: String(o.employee || ""),
      tableNo: String(o.tableNo || ""),
      takeaway: !!o.takeaway,
      note: String(o.note || ""),
      items: Array.isArray(o.items) ? o.items : [],
      total: Number(o.total || 0),
      createdAt: String(o.createdAt || (new Date()).toISOString()),
      lang: String(body.lang || ""),
      deviceId: String(body.deviceId || "")
    };
  }

  // 新格式：{ table, type, note, lang, deviceId, items:[{id,name,qty,price,amount}], total }
  var table = String(body.table || "");
  var typeText = String(body.type || "");
  var takeaway = (typeText === "外带" || typeText.toLowerCase() === "takeaway" || typeText.toLowerCase() === "mang đi");
  var note = String(body.note || "");
  var lang = String(body.lang || "");
  var deviceId = String(body.deviceId || "");
  var items = Array.isArray(body.items) ? body.items : [];
  var total = Number(body.total || 0);

  var oid = (deviceId ? deviceId : "dev") + "-" + (new Date()).getTime();

  return {
    id: oid,
    employee: "",
    tableNo: table,
    takeaway: takeaway,
    note: note,
    items: items,
    total: total,
    createdAt: (new Date()).toISOString(),
    lang: lang,
    deviceId: deviceId
  };
}
