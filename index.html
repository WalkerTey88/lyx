<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>点单系统</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f8f8f8; }
    header { background: #b30f17; color: white; text-align: center; padding: 10px; font-size: 20px; }
    .container { padding: 15px; }
    button { padding: 8px 12px; margin: 4px; border: none; background: #b30f17; color: white; border-radius: 4px; cursor: pointer; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    input, textarea { width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ccc; border-radius: 4px; }
    #cart { background: white; padding: 10px; border-radius: 6px; }
    #print-area { display: none; }
  </style>
</head>
<body>
  <header>点单系统</header>
  <div class="container">
    <label>桌号：</label>
    <input id="tableNo" type="text" placeholder="请输入桌号">
    <label><input type="checkbox" id="takeaway"> 打包</label>
    <textarea id="note" placeholder="备注"></textarea>

    <div id="menu">
      <!-- 菜单内容示例 -->
      <button onclick="addToCart('wonton',1)">云吞面 RM 8.50</button>
      <button onclick="addToCart('drink',1)">饮料 RM 3.00</button>
    </div>

    <h3>购物车</h3>
    <div id="cart"></div>

    <button id="btn-done" onclick="finishAndSend()">完成并统计</button>
    <button onclick="printReceipt()">打印收据</button>
  </div>

  <div id="print-area"></div>

  <script>
    // 示例菜单数据
    const prices = { wonton: 8.5, drink: 3.0 };
    const names = { wonton: "云吞面", drink: "饮料" };
    let cart = {};

    function priceOf(id){ return prices[id] || 0; }
    function nameOf(id){ return names[id] || id; }

    function addToCart(id, qty){
      cart[id] = (cart[id] || 0) + qty;
      renderCart();
    }
    function renderCart(){
      const box=document.getElementById('cart');
      box.innerHTML='';
      let subtotal=0;
      Object.keys(cart).forEach(id=>{
        const qty=cart[id];
        const amt=priceOf(id)*qty; subtotal+=amt;
        box.innerHTML += `<div>${nameOf(id)} × ${qty} = RM ${amt.toFixed(2)}</div>`;
      });
      box.innerHTML += `<hr><b>合计: RM ${subtotal.toFixed(2)}</b>`;
    }

    function loadStats(){
      try{ return JSON.parse(localStorage.getItem("stats")||"{\"orders\":0,\"items\":0,\"sales\":0,\"list\":[]}"); }
      catch(e){ return {orders:0,items:0,sales:0,list:[]}; }
    }
    function saveStats(st){
      localStorage.setItem("stats", JSON.stringify(st));
    }

    function showKpis(){
      console.log("统计更新:", loadStats());
    }

    function t(k){ 
      const map={alert_pick:"请先选择商品",alert_empty:"购物车为空",done:"完成并统计",
                 takeaway:"打包",dinein:"堂食",title_main:"收据",title_sub:"谢谢惠顾",
                 time:"时间",table:"桌号",type:"类型",sum_total:"总计"};
      return map[k]||k; 
    }

    // 模拟云端配置
    const CLOUD={ SECRET:"demo", SPREADSHEET_ID:"demo", ENDPOINT:"/api" };
  </script>

  <!-- === FINAL OPTIMIZATION PATCH === -->
  <script defer>
  /* ---------- Helpers ---------- */
  function __escapeHTML__(s){
    return String(s).replace(/[&<>"'`=\/]/g, function (c) {
      return ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"
      })[c];
    });
  }
  function __fmtRM__(n){ 
    const x = (typeof n === 'number') ? n : +(n||0); 
    return "RM " + x.toFixed(2); 
  }

  /* ---------- Lazy load images ---------- */
  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll("img").forEach(img => {
      if(!img.hasAttribute("loading")) img.setAttribute("loading","lazy");
    });
  });

  /* ---------- Language persistence ---------- */
  (function(){
    try{
      const saved = localStorage.getItem("lyx_lang");
      if(saved && typeof saved === "string"){ window.LANG = saved; }
    }catch(e){}
  })();
  if (typeof setLang === 'function') {
    const __orig_setLang__ = setLang;
    window.setLang = function(next){
      try{ localStorage.setItem("lyx_lang", next); }catch(e){}
      __orig_setLang__(next);
    };
  }

  /* ---------- Prevent double-submit ---------- */
  let __SENDING__ = false;
  if (typeof finishAndSend === 'function'){
    window.finishAndSend = async function(){
      if(Object.keys(cart||{}).length===0){ alert(t('alert_pick')); return; }
      if(__SENDING__) return;
      __SENDING__ = true;
      const btn = document.getElementById('btn-done');
      const btnText = btn ? btn.textContent : '';
      if(btn){
        btn.disabled = true;
        btn.textContent = (t('done') || '完成并统计') + '…';
      }
      try{
        const table = document.getElementById('tableNo').value || "-";
        const type  = document.getElementById('takeaway').checked ? t('takeaway') : t('dinein');
        const note  = (document.getElementById('note').value||"").trim();

        let subtotal=0, itemsCount=0, lines=[], itemsArr=[];
        Object.keys(cart).forEach(id=>{
          const qty=cart[id]; itemsCount+=qty;
          const lineAmt = priceOf(id)*qty; subtotal+=lineAmt;
          lines.push(`- ${nameOf(id)} × ${qty} = ${__fmtRM__(lineAmt)}`);
          itemsArr.push({id, qty, amount:+lineAmt.toFixed(2)});
        });

        const st=loadStats();
        st.orders += 1; st.items += itemsCount; st.sales = +(st.sales + subtotal).toFixed(2);
        st.list.push({time:new Date().toLocaleString(), table, type, lines, items_struct:itemsArr, total:subtotal, note});
        saveStats(st);

        alert(`已保存到本机统计。\n订单笔数：${st.orders}，销售额：${__fmtRM__(st.sales)}。\n将尝试上传到云端…`);

        const cloudPayload = {
          secret: CLOUD.SECRET,
          spreadsheetId: CLOUD.SPREADSHEET_ID,
          table, type, note, lang: LANG,
          items: itemsArr.map(it => ({ id: it.id, name: nameOf(it.id), qty: it.qty, amount: it.amount })),
          total: +subtotal.toFixed(2)
        };
        let ok = false;
        try{
          const res = await fetch(CLOUD.ENDPOINT, {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify(cloudPayload)
          });
          if(res.ok){
            const j = await res.json().catch(()=>({ok:false}));
            ok = !!(j && j.ok);
          }
        }catch(e){ ok = false; }
        if(!ok){ alert('云端上传失败（网络/权限）。本机已保存，稍后再试。'); }
        else   { alert('云端上传成功 ✅'); }

        for(const k in cart) delete cart[k];
        renderCart(); showKpis();
      } finally {
        __SENDING__ = false;
        if(btn){
          btn.disabled = false;
          btn.textContent = btnText || t('done') || '完成并统计';
        }
      }
    };
  }

  /* ---------- Sanitize printing ---------- */
  if (typeof printReceipt === 'function'){
    window.printReceipt = function(){
      if(Object.keys(cart||{}).length===0){ alert(t('alert_empty')); return; }
      const area=document.getElementById('print-area'); area.classList.remove('hidden');
      const table=document.getElementById('tableNo').value||'-';
      const type=document.getElementById('takeaway').checked?t('takeaway'):t('dinein');
      let subtotal=0, body='';
      Object.keys(cart).forEach(id=>{
        const qty=cart[id], line=priceOf(id)*qty; subtotal+=line;
        body+=`<div>${__escapeHTML__(nameOf(id))} × ${qty}<span style="float:right">${__fmtRM__(line)}</span></div>`;
      });
      area.innerHTML=`
      <div style="max-width:340px;margin:0 auto;font-size:13px;line-height:1.35;color:#000;background:#fff;padding:8px;border:2px dashed ${getComputedStyle(document.documentElement).getPropertyValue('--line')}">
        <div style="text-align:center;font-weight:900;color:#b30f17">${__escapeHTML__(t('title_main'))}<br><small style="color:#333">${__escapeHTML__(t('title_sub'))}</small></div>
        <div>${__escapeHTML__(t('time'))}: ${new Date().toLocaleString()}</div>
        <div>${__escapeHTML__(t('table'))}: ${__escapeHTML__(table)}</div>
        <div>${__escapeHTML__(t('type'))}: ${__escapeHTML__(type)}</div>
        <hr>${body}<hr>
        <div style="font-weight:900">${__escapeHTML__(t('sum_total'))}: ${__fmtRM__(subtotal)}</div>
      </div>`;
      window.print(); area.classList.add('hidden');
    };
  }
  </script>
  <!-- === /FINAL OPTIMIZATION PATCH === -->

</body>
</html>
